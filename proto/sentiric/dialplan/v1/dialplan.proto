syntax = "proto3";

package sentiric.dialplan.v1;

import "sentiric/user/v1/user.proto";

option go_package = "github.com/sentiric/sentiric-contracts/gen/go/sentiric/dialplan/v1;dialplanv1";

// =================================================================
//                            SERVICE DEFINITION
// =================================================================

service DialplanService {
  // Gelen çağrının nasıl yönlendirileceğine karar veren ana metot.
  rpc ResolveDialplan(ResolveDialplanRequest) returns (ResolveDialplanResponse);

  // Inbound Route Yönetimi
  rpc CreateInboundRoute(CreateInboundRouteRequest) returns (CreateInboundRouteResponse);
  rpc GetInboundRoute(GetInboundRouteRequest) returns (GetInboundRouteResponse);
  rpc UpdateInboundRoute(UpdateInboundRouteRequest) returns (UpdateInboundRouteResponse);
  rpc DeleteInboundRoute(DeleteInboundRouteRequest) returns (DeleteInboundRouteResponse);
  rpc ListInboundRoutes(ListInboundRoutesRequest) returns (ListInboundRoutesResponse);
  
  // Dialplan Yönetimi
  rpc CreateDialplan(CreateDialplanRequest) returns (CreateDialplanResponse);
  rpc GetDialplan(GetDialplanRequest) returns (GetDialplanResponse);
  rpc UpdateDialplan(UpdateDialplanRequest) returns (UpdateDialplanResponse);
  rpc DeleteDialplan(DeleteDialplanRequest) returns (DeleteDialplanResponse);
  rpc ListDialplans(ListDialplansRequest) returns (ListDialplansResponse);
}

// =================================================================
//                        CORE MESSAGES & ENUMS
// =================================================================

// Dialplan aksiyon tipleri (Telekom-First standardı)
// LINT FIX: Değerler enum ismi ile prefix'lendi.
enum ActionType {
  ACTION_TYPE_UNSPECIFIED = 0;
  ACTION_TYPE_START_AI_CONVERSATION = 1;      // Agent-Service orkestrasyonu
  ACTION_TYPE_BRIDGE_CALL = 2;                // Dahili abone-abone köprüleme
  ACTION_TYPE_ECHO_TEST = 3;                  // Media-Service native loopback
  ACTION_TYPE_PLAY_STATIC_ANNOUNCEMENT = 4;   // AI olmayan sabit anons
}

message DialplanAction {
  // action: Geriye dönük uyum için string formatı (örn: "ECHO_TEST")
  string action = 1; 
  
  // type: Tip-güvenli aksiyon seçimi
  ActionType type = 2;

  // action_data: Aksiyon için gerekli parametreler (örn: announcement_id, voice_id)
  // Eski ActionData mesajı yerine daha esnek olan map yapısına geçildi.
  map<string, string> action_data = 3;
}

message ResolveDialplanRequest {
  string caller_contact_value = 1;
  string destination_number = 2;
}

message ResolveDialplanResponse {
  string dialplan_id = 1;
  string tenant_id = 2;
  DialplanAction action = 3;
  optional sentiric.user.v1.User matched_user = 4;
  optional sentiric.user.v1.Contact matched_contact = 5;
  optional InboundRoute inbound_route = 6;
}

message InboundRoute {
  string phone_number = 1;
  string tenant_id = 2;
  optional string active_dialplan_id = 3;
  optional string off_hours_dialplan_id = 4;
  optional string failsafe_dialplan_id = 5;
  bool is_maintenance_mode = 6;
  string default_language_code = 7;
}

message Dialplan {
    string id = 1;
    string tenant_id = 2;
    string description = 3;
    DialplanAction action = 4;
}

// =================================================================
//                  MANAGEMENT MESSAGES (CRUD)
// =================================================================

message CreateInboundRouteRequest { InboundRoute route = 1; }
message CreateInboundRouteResponse { InboundRoute route = 1; }
message GetInboundRouteRequest { string phone_number = 1; }
message GetInboundRouteResponse { InboundRoute route = 1; }
message UpdateInboundRouteRequest { InboundRoute route = 1; }
message UpdateInboundRouteResponse { InboundRoute route = 1; }
message DeleteInboundRouteRequest { string phone_number = 1; }
message DeleteInboundRouteResponse { bool success = 1; }
message ListInboundRoutesRequest { string tenant_id = 1; int32 page_size = 2; int32 page = 3; }
message ListInboundRoutesResponse { repeated InboundRoute routes = 1; int32 total_count = 2; }

message CreateDialplanRequest { Dialplan dialplan = 1; }
message CreateDialplanResponse { Dialplan dialplan = 1; }
message GetDialplanRequest { string id = 1; }
message GetDialplanResponse { Dialplan dialplan = 1; }
message UpdateDialplanRequest { Dialplan dialplan = 1; }
message UpdateDialplanResponse { Dialplan dialplan = 1; }
message DeleteDialplanRequest { string id = 1; }
message DeleteDialplanResponse { bool success = 1; }
message ListDialplansRequest { string tenant_id = 1; int32 page_size = 2; int32 page = 3; }
message ListDialplansResponse { repeated Dialplan dialplans = 1; int32 total_count = 2; }